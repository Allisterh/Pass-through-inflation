---
Title: Estimación de los Umbrales
output:
  pdf_document: default
  html_document: default
---

```{r cargando librerias, echo=FALSE, include=FALSE}

library(readxl)
library(tidyverse)
library(NTS)
library(knitr)
library(kableExtra)
library(devtools)
```

```{r Cargando datos, echo=FALSE}

datos <- read_excel("D:/Documentos/PES/Para la tesis/Tesis/Pass through/Datos/Datos.xlsx", sheet = "Datos consolidados")

```

# Estimación de los umbrales de inflacón para la estimación del efecto *Pass through*

Para la estimación de los umbrales del modelo TAR se seguirá la metodología propuesta por Chang(1993). Para ello se estima el modelo para cada uno de los umbrales posibles[^1] y se toma como regla de decisión para escogerlos aquellos que minicen la suma de residuos al cuadrado. Es por medio de los umbrales que se determinarán los distintos regímenes inflacionarios que determinarán el efecto *pass through*.

El modelo a estiamr es:

\[\Delta^{12}P_t =\beta_0 + \beta_1\Delta^{12}P_{t-1} + \beta_2e_t^{12} + 
\delta_ae_t^{12}*(\Delta^{12}P_{t-1}<\tau) + \beta_3\Delta^{12}P_{Et}^{12} + \beta_4y_t^{brecha}\]

donde:

$\Delta^{12}P_t$ Variación relativa anualizada del Índice de Precios al Consumidor

$\beta_0$ Componente autónomo de la tas de inflación

$e_t^{12}$ Depreciación anualizada del tipo de cambio

$\Delta^{12}P_{Et}^{12}$ Variación relativa anualidad del Índice de Precios al Consumidor de Estados Unidos

$y_t^{brecha}$ Brecha relativa del producto respecto del potencial

$\tau$ Detona el valor del umbral para el régimen de inflación

$\Delta^{12}P_{t-1}<\tau$ Variable dicotómica que es 1 en régimen de inflación alta y 0 en régimen de iflación baja

En donde es claro que el uso de la dicotómica separa los regímenes de inflación. 

```{r modelos}

# Construcción de data frame a utilizar

attach(datos)

datos_modelo <- data.frame(inf_gt_anualizada, inf_eua_anualizada, 
                           var_brecha, deprec_anualizada)

datos_modelo <- datos_modelo*100

detach(datos)

# construcción de la infalción inercial (inflación del periodo anterior)

inercial <- c(NA, datos_modelo[c(1:256),1])

datos_modelo <- cbind(datos_modelo, inercial)
datos_modelo <- select(.data = datos_modelo, inf_gt_anualizada, inercial, 
                       inf_eua_anualizada, var_brecha, deprec_anualizada)
datos_modelo <- datos_modelo[c(2:257),]

# Reordenando índices
row.names(datos_modelo) <- c(1:256)

```

\begin{center}
Datos a utilizar
\end{center}

```{r Tabla de datos, echo=FALSE}

# con linebrake dentro del agumento col.names podemos separar 
# los nombres según lo especifiquemos

kable(head(datos_modelo), digits = 5,
      col.names = linebreak(c("inflación anualizada\nGuatemala", 
                    "inflación inercial\nGuatemala", 
                    "inflación anualizada\nEstados Unidos",
                    "brecha del producto", 
                    "Depreciación anualizada\nQuetzales x USD 1"), 
                    align = "c"), 
      align = "c", escape = FALSE)

```

## Estimación de los distintos modelos

Como se especificó la varialbe dicotómica $\Delta^{12}P_{t-1}<\tau$ será 0 si el régimen de inflación es bajo o 1 si el régimen de inflación es alto, todo para cada uno de los umbrales posibles.

```{r estimación de modelos}
# Creación de todos los posibles umbrales
# Número de umbrales fuera por debajo o arriba de la muestra

umbrales_fuera <- length(inercial) - round(257 - 257*0.3, digits = 0)

# posibles umbrales del modelo

posibles <- sort(inercial)
posibles <- posibles[round((umbrales_fuera/2 + 1), 0):
                       (length(inercial)-round(umbrales_fuera/2,0))] 


# Lista de modelos

nombre_modelos <- c()
modelos <- list()
bases <- list()

# Estimación de los modelos por cada umbral

for (i in c(1:length(posibles))) {
  
  nombre_modelos[i] <- c(sprintf("modelo_%s_%s", i, posibles[i]))
  
  m <- mutate(datos_modelo, 
                     d = ifelse(inercial<posibles[i], yes = 0, no = 1))
  
  bases[[i]] <- m
  
  modelo <- lm(bases[[i]],
                      formula = inf_gt_anualizada ~ 1 +
                        deprec_anualizada*d + inercial +
                        inf_eua_anualizada + var_brecha - d)
  
  modelos[[i]] <- modelo
  
}

names(modelos) <- nombre_modelos
```

Luego de la estimación de los modelos se procede al cálculo de la suma de residuos al cuadrado (ssr) de cada modelo.

```{r calculo SSR}

ssr <- c()

for (i in c(1:length(posibles))) {
  
  ssr[i] <- sum(modelos[[i]]$residuals^2)
  
}
```

## Identificación de los umbrales

Una vez determinada la ssr se procede a la identificacióno de los umbrales escogiendo aquellos que minimicen la ssr.
```{r identificación tau 1}

names(modelos[ssr==min(ssr)])

# eliminamos la primera ssr para poder obtener nuevamente el seungo umbral

ssr2 <- ssr[ssr != min(ssr)]

names(modelos[ssr2 == min(ssr2)])

# Como se observa son los modelos 11 y 12 con inflación de 0.01692999 anual
# los modelo con menor ssr y por lo tanto este es el primer umbral.

# Forma grafica de identificacion del umbral

ggplot() + 
  geom_line(aes(y = ssr, x = posibles), colour = "#2A5783", size = 1) +
  geom_vline(xintercept = posibles[ssr == min(ssr)], 
             linetype = 4, size = 1) +
  geom_vline(xintercept = posibles[ssr2 == min(ssr2)][3],
             linetype = 4, size = 1) +
  labs(title = "Estimación de los umbrales", 
       y = "Suma de residuos al cuadrado", x = "Umbrales posibles") +
  #geom_text(aes(y = min(ssr), x = posibles[ssr == min(ssr)][1],
                #label = "Primer umbral \n0.0169"), size = 3.5) +
  #geom_text(aes(y = min(ssr2), x = posibles[ssr2 == min(ssr2)][3],
                #label = "Segundo umbral\n0.05409"), size = 3.03) +
  theme_classic(base_size = 15)
  
```

# Estiamción del modelo con dos umbrales, tres regímenes

Una vez determinado el conjunto de umbrales se procede a la estimación del modelo TAR con tres regímenes inflacionarios.

La nueva especificación es:

\[\Delta^{12}P_t = \beta_0 + \beta_1\Delta^{12}P_{t-1} + \beta_2e^{12}_t  
+ \delta_ae^{12}_t*(\Delta^{12}P_{t-1}<0.016929)+ 
\delta_be^{12}_t*(0.016929\leq\Delta^{12}P_{t-1}<0.05409)+
\beta_3\Delta^{12}P_{Et}^{12} + \beta_4y_t^{brecha}\]

En este caso $(0.016929\leq\Delta^{12}P_{t-1}<0.05409)$ la dicotómica que es 1 si nos encontramos en el regimen de infalción media y es 0 si nos encontramos en el régimen de inflación alta, esto con el fin de establecer el regímen de infalción baja acomo el escenario base.

```{r Estimación del modelo TAR, include = FALSE}

datos_TAR <- datos_modelo %>% 
                mutate(dmen = ifelse(inercial < 1.692996, yes = 1, no = 0),
                       dentre = ifelse(inercial>= 1.692996 & inercial<5.409668,
                                       yes = 1, no = 0))

# Por la forma en la que están construidas las dicotómicas el escenario base
# Es el escenario de infalción baja

attach(datos_TAR)

TAR <- lm(datos_TAR, formula = inf_gt_anualizada ~ 1 +
            deprec_anualizada*dmen + deprec_anualizada*dentre +
            inercial + inf_eua_anualizada + var_brecha - dmen - dentre)

detach(datos_TAR)

summary(TAR)

```

